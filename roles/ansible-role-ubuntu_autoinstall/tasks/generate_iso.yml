-   name: Ensure output ISO is absent (cleanup before build)
    ansible.builtin.file:
        path: "{{ target_dir }}/ubuntu_autoinstall_{{ iso_arch }}.iso"
        state: absent

-   name: Prepare work dir
    ansible.builtin.file:
        path: "{{ target_dir }}/work"
        state: directory

-   name: Generate autoinstall.yaml
    ansible.builtin.template:
        src: autoinstall.yaml.j2
        dest: "{{ target_dir }}/work/autoinstall.yaml"

# Wichtig: alte Extrakte lÃ¶schen, damit du sicher frisch extrahierst
-   name: Remove previously extracted boot config files
    ansible.builtin.file:
        path: "{{ item }}"
        state: absent
    loop:
        - "{{ target_dir }}/work/grub.cfg"
        - "{{ target_dir }}/work/loopback.cfg"
        - "{{ target_dir }}/work/efi_grub.cfg"
        - "{{ target_dir }}/work/txt.cfg"

-   name: Extract /boot/grub/grub.cfg
    ansible.builtin.shell: >-
        xorriso -osirrox on
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -extract /boot/grub/grub.cfg {{ target_dir }}/work/grub.cfg

-   name: Extract /boot/grub/loopback.cfg (if present)
    ansible.builtin.shell: >-
        xorriso -osirrox on
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -extract /boot/grub/loopback.cfg {{ target_dir }}/work/loopback.cfg
    register: extract_loopback
    failed_when: false
    changed_when: extract_loopback.rc == 0

-   name: Extract /EFI/BOOT/grub.cfg (if present)
    ansible.builtin.shell: >-
        xorriso -osirrox on
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -extract /EFI/BOOT/grub.cfg {{ target_dir }}/work/efi_grub.cfg
    register: extract_efi_grub
    failed_when: false
    changed_when: extract_efi_grub.rc == 0

-   name: Extract /isolinux/txt.cfg (if present)
    ansible.builtin.shell: >-
        xorriso -osirrox on
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -extract /isolinux/txt.cfg {{ target_dir }}/work/txt.cfg
    register: extract_isolinux
    failed_when: false
    changed_when: extract_isolinux.rc == 0

# --- Patch: super einfache Regel
# Jede Zeile "linux .... ---" bekommt " autoinstall" vor die --- (nur wenn noch nicht enthalten)

-   name: Insert autoinstall before --- in grub.cfg
    ansible.builtin.replace:
        path: "{{ target_dir }}/work/grub.cfg"
        regexp: '(?m)^(\s*linux\s+.*)\s+---\s*$'
        replace: '\1 autoinstall ---'

-   name: Insert autoinstall before --- in loopback.cfg (if present)
    ansible.builtin.replace:
        path: "{{ target_dir }}/work/loopback.cfg"
        regexp: '(?m)^(\s*linux\s+.*)\s+---\s*$'
        replace: '\1 autoinstall ---'
    when: extract_loopback.rc == 0

-   name: Insert autoinstall before --- in isolinux txt.cfg (if present)
    ansible.builtin.replace:
        path: "{{ target_dir }}/work/txt.cfg"
        regexp: '(?m)^(\s*append\s+.*)\s+---\s*$'
        replace: '\1 autoinstall ---'
    when: extract_isolinux.rc == 0

-   name: Build new ISO (patched boot configs + autoinstall.yaml)
    ansible.builtin.shell: >-
        xorriso
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -outdev {{ target_dir }}/ubuntu_autoinstall_{{ iso_arch }}.iso
        -boot_image any replay
        -map {{ target_dir }}/work/autoinstall.yaml /autoinstall.yaml
        -map {{ target_dir }}/work/grub.cfg /boot/grub/grub.cfg
        {% if extract_loopback.rc == 0 %}-map {{ target_dir }}/work/loopback.cfg /boot/grub/loopback.cfg{% endif %}
        {% if extract_efi_grub.rc == 0 %}-map {{ target_dir }}/work/efi_grub.cfg /EFI/BOOT/grub.cfg{% endif %}
        {% if extract_isolinux.rc == 0 %}-map {{ target_dir }}/work/txt.cfg /isolinux/txt.cfg{% endif %}

-   name: Delete work dir
    ansible.builtin.file:
        path: "{{ target_dir }}/work"
        state: absent
