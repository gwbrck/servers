-   name: Ensure output ISO is absent (cleanup before build)
    file:
      path: "{{ target_dir }}/ubuntu_autoinstall_{{ iso_arch }}.iso"
      state: absent

-   name: Prepare work dir
    file:
      path: "{{ target_dir }}/work"
      state: directory

-   name: Generate autoinstall.yaml
    template:
      src: autoinstall.yaml.j2
      dest: "{{ target_dir }}/work/autoinstall.yaml"

-   name: Build new ISO (keep original boot config, add autoinstall.yaml at ISO root)
    shell:
      cmd: >-
        xorriso
        -indev {{ target_dir }}/noble-live-server-{{ iso_arch }}.iso
        -outdev {{ target_dir }}/ubuntu_autoinstall_{{ iso_arch }}.iso
        -boot_image any replay
        -volid "ubuntu-autoinstall_{{ iso_arch }}"
        -map {{ target_dir }}/work/autoinstall.yaml /autoinstall.yaml

-   name: Delete work dir
    file:
      path: "{{ target_dir }}/work"
      state: absent
