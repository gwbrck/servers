services:
  immich-server:
    image: "ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}"
    container_name: "immich-server"
    restart: unless-stopped
    env_file: .env
    volumes:
      - "{{ immich_data_dir }}:/data"
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - redis
      - database
    healthcheck:
      disable: false
    labels:
      - "traefik.enable={{ immich_traefik_enable | default(true) | ternary('true', 'false') }}"
      - "traefik.docker.network={{ immich_traefik_network }}"
      - "traefik.http.routers.{{ immich_traefik_router_name }}.rule=Host(`{{ immich_public_url }}`)"
      - "traefik.http.routers.{{ immich_traefik_router_name }}.entrypoints=websecure"
      - "traefik.http.routers.{{ immich_traefik_router_name }}.tls.certresolver={{ immich_traefik_cert_resolver }}"
      - "traefik.http.services.{{ immich_traefik_router_name }}.loadbalancer.server.port=2283"
    networks:
      - "{{ immich_traefik_network }}"
      - immich-internal

  immich-machine-learning:
    image: "ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}"
    container_name: "immich-machine-learning"
    restart: unless-stopped
    env_file: .env
    volumes:
      - model-cache:/cache
    healthcheck:
      disable: false
    networks:
      - immich-internal

  redis:
    image: "docker.io/valkey/valkey:9"
    container_name: "immich-redis"
    restart: unless-stopped
    healthcheck:
      test: redis-cli ping || exit 1
    networks:
      - immich-internal

  database:
    image: "ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0"
    container_name: "immich-postgres"
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
      POSTGRES_USER: "${DB_USERNAME}"
      POSTGRES_DB: "${DB_DATABASE_NAME}"
      POSTGRES_INITDB_ARGS: "--data-checksums"
    volumes:
      - "{{ immich_db_dir }}:/var/lib/postgresql/data"
    shm_size: "128mb"
    healthcheck:
      disable: false
    networks:
      - immich-internal

volumes:
  model-cache:

networks:
  {{ immich_traefik_network }}:
    name: {{ immich_traefik_network }}
    external: true
  immich-internal:
