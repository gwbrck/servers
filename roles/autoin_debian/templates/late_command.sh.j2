#!/bin/bash
# Managed by Ansible.
set -euxo pipefail

ADMIN_USER="{{ autoin_debian_admin_user }}"
RAID_MOUNTPOINT="{{ autoin_debian_raid_mountpoint }}"

{% set root_keys = autoin_debian_root_authorized_keys | reject('equalto', '') | list %}
{% if root_keys %}
install -d -m 700 /root/.ssh
cat <<'EOF' > /root/.ssh/authorized_keys
{{ root_keys | join('\n') }}
EOF
chmod 600 /root/.ssh/authorized_keys
chown root:root /root/.ssh/authorized_keys
{% endif %}

{% if autoin_debian_admin_ssh_public_key | default('', true) | trim %}
install -d -m 700 /home/${ADMIN_USER}/.ssh
cat <<'EOF' > /home/${ADMIN_USER}/.ssh/authorized_keys
{{ autoin_debian_admin_ssh_public_key | trim }}
EOF
chown -R ${ADMIN_USER}:${ADMIN_USER} /home/${ADMIN_USER}/.ssh
chmod 700 /home/${ADMIN_USER}/.ssh
chmod 600 /home/${ADMIN_USER}/.ssh/authorized_keys
{% endif %}

