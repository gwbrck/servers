- name: Verify Proxmox base ISO exists
  ansible.builtin.stat:
    path: "{{ autoin_proxmox_iso_source_path }}"
  register: autoin_proxmox_iso_source_stat

- name: Abort when Proxmox base ISO is unavailable
  ansible.builtin.fail:
    msg: >-
      Proxmox base ISO not found at {{ autoin_proxmox_iso_source_path }}. Download the official ISO
      and update autoin_proxmox_iso_source_path accordingly.
  when: not autoin_proxmox_iso_source_stat.stat.exists

- name: Prepare Proxmox ISO workspace directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0750"
  loop:
    - "{{ autoin_proxmox_iso_workdir }}"
    - "{{ autoin_proxmox_iso_workdir }}/build"

- name: Render Proxmox auto-install answer file
  ansible.builtin.template:
    src: answer.toml.j2
    dest: "{{ autoin_proxmox_iso_workdir }}/answer.toml"
    mode: "0600"
  no_log: true

- name: Render Proxmox post-install script
  ansible.builtin.template:
    src: postinstall.sh.j2
    dest: "{{ autoin_proxmox_iso_workdir }}/postinstall.sh"
    mode: "0700"
  no_log: true

- name: Build Proxmox auto-install ISO via containerized assistant
  community.docker.docker_container:
    name: autoin-proxmox-iso-build
    image: "{{ autoin_proxmox_iso_container_image }}"
    pull: true
    recreate: true
    auto_remove: false
    platform: "{{ autoin_proxmox_iso_container_platform }}"
    working_dir: /workspace
    volumes:
      - "{{ autoin_proxmox_iso_workdir }}:/workspace"
      - "{{ autoin_proxmox_iso_source_path }}:/iso/base.iso:ro"
    command: >
      /bin/bash -lc
      "set -euxo pipefail;
      ls -lah /iso;
      test -f /iso/base.iso;
      export DEBIAN_FRONTEND=noninteractive;
      apt-get update;
      apt-get install -y --no-install-recommends ca-certificates curl gnupg;
      install -d -m 0755 /etc/apt/keyrings;
      curl -fsSL {{ autoin_proxmox_iso_container_repo_key_url }} -o /etc/apt/keyrings/proxmox.gpg;
      echo 'deb [signed-by=/etc/apt/keyrings/proxmox.gpg] {{ autoin_proxmox_iso_container_repo }}' > /etc/apt/sources.list.d/proxmox.list;
      apt-get update;
      apt-get install -y --no-install-recommends proxmox-auto-install-assistant xorriso squashfs-tools p7zip-full ca-certificates curl gnupg;
      proxmox-auto-install-assistant validate-answer /workspace/answer.toml;
      proxmox-auto-install-assistant prepare-iso \
        --fetch-from iso \
        --output /workspace/proxmox-auto-install.iso \
        --answer-file /workspace/answer.toml \
        --on-first-boot /workspace/postinstall.sh \
        --tmp /workspace/build \
        /iso/base.iso;"
    tty: true
    detach: false
  register: autoin_proxmox_iso_build
  no_log: true

- name: Remove build container after result collection
  community.docker.docker_container:
    name: autoin-proxmox-iso-build
    state: absent
  when: autoin_proxmox_iso_build is not failed

- name: Check for generated Proxmox ISO artifact
  ansible.builtin.stat:
    path: "{{ autoin_proxmox_iso_workdir }}/proxmox-auto-install.iso"
  register: autoin_proxmox_iso_artifact

- name: Show ISO build command output
  ansible.builtin.debug:
    msg:
      - "Container stdout:\n{{ autoin_proxmox_iso_build.stdout | default('<no stdout>', true) }}"
      - "Container stderr:\n{{ autoin_proxmox_iso_build.stderr | default('<no stderr>', true) }}"
    no_log: true
  when:
    - not autoin_proxmox_iso_artifact.stat.exists

- name: Abort when Proxmox ISO artifact is missing
  ansible.builtin.fail:
    msg: >-
      Expected ISO at {{ autoin_proxmox_iso_workdir }}/proxmox-auto-install.iso but it was not created.
      Review the container output above for details.
  when:
    - not autoin_proxmox_iso_artifact.stat.exists

- name: Remove sensitive Proxmox build artifacts
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ autoin_proxmox_iso_workdir }}/answer.toml"
    - "{{ autoin_proxmox_iso_workdir }}/postinstall.sh"
    - "{{ autoin_proxmox_iso_workdir }}/build"
  loop_control:
    label: "{{ item | basename }}"
  when:
    - autoin_proxmox_iso_artifact.stat.exists

- name: Show ISO build results summary
  ansible.builtin.debug:
    msg:
      - "Generated ISO kept at {{ autoin_proxmox_iso_workdir }}/proxmox-auto-install.iso"
      - "Sensitive files (answer.toml, postinstall.sh, build/) removed from workspace"
    verbosity: 1
