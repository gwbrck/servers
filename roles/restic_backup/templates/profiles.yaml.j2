version: "2"
global:
  restic-binary: "{{ restic_backup_target_bin }}/restic"
  scheduler: "systemd"


groups:
  nightly-backup:
    description: "TÃ¤gliche Backups aller Profile"
    continue-on-error: true
    profiles:
      - vaultwarden
      - actual
      - opencloud
      - audiobookshelf
      - archiv_gregor
      - freshrss
      - immich
      - mealie
    schedules:
      backup:
        at: "*-*-* 03:30:00"
        permission: system

  weekly-check:
    description: "WÃ¶chentliche Checks aller Profile"
    continue-on-error: true
    profiles:
      - vaultwarden
      - actual
      - opencloud
      - audiobookshelf
      - archiv_gregor
      - freshrss
      - immich
      - mealie
    schedules:
      check:
        at: "Sun *-*-* 04:30:00"
        permission: system

profiles:
  default:
    repository: "s3:https://{{ restic_backup_s3_endpoint }}/{{ restic_backup_s3_bucket }}"
    initialize: true
    env-file: "{{ restic_backup_env_file }}"
    status-file: backup-status.json
    retention:
      keep-daily: 7
      keep-weekly: 4
      keep-monthly: 6
      after-backup: true
      tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
    snapshots:
      tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
      send-after:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: "Snapshots wurden erfolgreich aufgelistet."
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}âœ… Snapshots OK: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "file_folder"
      send-after-fail:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: "${ERROR}\n\n${ERROR_STDERR}"
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}ðŸš¨ Snapshots Fehler: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "warning"
            - name: Priority
              value: "4"
    backup:
      tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
      schedule-permission: system
      send-after:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: "Backup erfolgreich beendet."
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}âœ… Erfolg: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "white_check_mark"
            - name: Priority
              value: "2"
      send-after-fail:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: |
            Fehler beim Backup!

            Log Output:
            ${ERROR}
            ${ERROR_STDERR}
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}ðŸš¨ FEHLER: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "rotating_light,warning"
            - name: Priority
              value: "4" # Max/Urgent priority
    check:
      tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
      schedule-permission: system
      send-after:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: "Repository ist gesund."
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}ðŸ’š Check OK: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "green_heart"
      send-after-fail:
        - method: POST
          url: {{ restic_backup_ntfy_url }}/{{ restic_backup_ntfy_topic }}
          body: "${ERROR}\n\n${ERROR_STDERR}"
          headers:
            - name: Authorization
              value: Bearer {{ restic_backup_ntfy_token }}
            - name: Title
              value: "{% raw %}ðŸ’€ Check CRITICAL: {{ .Profile.Name }}{% endraw %}"
            - name: Tags
              value: "skull_and_crossbones"
            - name: Priority
              value: "4"

  vaultwarden:
    inherit: default
    run-before:
      - "docker compose -f {{ services_compose_base }}/vaultwarden/{{ default_compose_file }} exec -T vaultwarden /vaultwarden backup"
      - >-
        /bin/sh -c 'latest=$(ls -t {{ services_data_base }}/vw/db_[0-9]*.sqlite3 2>/dev/null | head -n 1);
        if [ -n "$latest" ]; then rm -f {{ services_data_base }}/vw/db_backup.sqlite3; mv -- "$latest" {{ services_data_base }}/vw/db_backup.sqlite3; fi'
      - >-
        /bin/sh -c 'rm -f {{ services_data_base }}/vw/db_[0-9]*.sqlite3'
    backup:
      source:
        - "{{ services_data_base }}/vw"
      exclude:
        - "{{ services_data_base }}/vw/db.sqlite3"
        - "{{ services_data_base }}/vw/db.sqlite3-wal"
        - "{{ services_data_base }}/vw/db.sqlite3-shm"
        - "{{ services_data_base }}/vw/tmp"
        - "{{ services_data_base }}/vw/sends"

  audiobookshelf:
    inherit: default
    run-before:
      - >-
        /bin/sh -c 'latest=$(ls -t {{ services_data_base }}/audiobookshelf/metadata/backups/* 2>/dev/null | head -n 1);
        if [ -n "$latest" ]; then rm -f {{ services_data_base }}/audiobookshelf/metadata/backups/audiobookshelf_backup.audiobookshelf; cp -a "$latest" {{ services_data_base }}/audiobookshelf/metadata/backups/audiobookshelf_backup.audiobookshelf; fi'
    backup:
      source:
        - "{{ services_data_base }}/audiobookshelf/audiobooks"
        - "{{ services_data_base }}/audiobookshelf/podcasts"
        - "{{ services_data_base }}/audiobookshelf/metadata/backups"
        - "{{ services_data_base }}/audiobookshelf/config"

  actual:
    inherit: default
    run-before:
      - "docker compose -f {{ services_compose_base }}/actual_budget/{{ default_compose_file }} stop actual_server"
    run-after:
      - "docker compose -f {{ services_compose_base }}/actual_budget/{{ default_compose_file }} start actual_server"
    backup:
      source:
        - "{{ services_data_base }}/actual/server-files"
        - "{{ services_data_base }}/actual/user-files"

  opencloud:
    inherit: default
    run-before:
      - "docker compose -f {{ services_compose_base }}/opencloud/{{ default_compose_file }} stop opencloud"
    run-after:
      - "docker compose -f {{ services_compose_base }}/opencloud/{{ default_compose_file }} start opencloud"
    backup:
      source:
        - "{{ services_data_base }}/opencloud/config"
        - "{{ services_data_base }}/opencloud/data"

  archiv_gregor:
    inherit: default
    backup:
      source:
        - "/srv/archiv_gregor"

  freshrss:
    inherit: default
    run-before:
      - "docker compose -f {{ services_compose_base }}/freshrss/{{ default_compose_file }} stop freshrss"
    run-after:
      - "docker compose -f {{ services_compose_base }}/freshrss/{{ default_compose_file }} start freshrss"
    backup:
      source:
        - "{{ services_data_base }}/freshrss"

  immich:
    inherit: default
    run-before:
      - >-
        docker compose -f {{ services_compose_base }}/immich/{{ default_compose_file }} exec -T database
        pg_dumpall --clean --if-exists --username='postgres'
        > {{ services_data_base }}/immich/library/database-backup/immich-database.sql
    backup:
      source:
        - "{{ services_data_base }}/immich/library"
      exclude:
        - "{{ services_data_base }}/immich/library/thumbs"
        - "{{ services_data_base }}/immich/library/encoded-video"

  mealie:
    inherit: default
    run-before:
      - "docker compose -f {{ services_compose_base }}/mealie/{{ default_compose_file }} stop mealie"
    run-after:
      - "docker compose -f {{ services_compose_base }}/mealie/{{ default_compose_file }} start mealie"
    backup:
      source:
        - "{{ services_data_base }}/mealie/data"
