version: 1
global:
  restic-binary: "/usr/local/bin/restic"
  scheduler: "systemd"


default:
  repository: "s3:https://{{ restic_s3_endpoint }}/{{ restic_s3_bucket }}"
  initialize: true
  env-file: "{{ resticprofile_env_file }}"
  retention:
    keep-daily: 7
    keep-weekly: 4
    keep-monthly: 6
    after-backup: true
    tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
  snapshots:
    tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
    send-before:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "Snapshot-Liste wird abgerufen..."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸ“‹ Snapshots: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "clipboard"
          - name: Priority
            value: "1" 
    send-after:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "Snapshots wurden erfolgreich aufgelistet."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}âœ… Snapshots OK: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "file_folder"
    send-after-fail:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "${ERROR}\n\n${ERROR_STDERR}"
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸš¨ Snapshots Fehler: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "warning"
          - name: Priority
            value: "3"   
  backup:
    tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
    schedule-permission: system
    send-before:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "Backup gestartet..."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸš€ Start: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "rocket"
          - name: Priority
            value: "1"
    send-after:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "Backup erfolgreich beendet."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}âœ… Erfolg: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "white_check_mark"
          - name: Priority
            value: "2" 
    send-after-fail:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: |
          Fehler beim Backup!
          
          Log Output:
          ${ERROR}
          ${ERROR_STDERR}
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸš¨ FEHLER: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "rotating_light,warning"
          - name: Priority
            value: "4" # Max/Urgent priority
  check:
    tag: "{% raw %}{{ .Profile.Name }}{% endraw %}"
    schedule-permission: system
    send-before:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "IntegritÃ¤ts-Check gestartet..."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸ” Check Start: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "mag" # Lupe
          - name: Priority
            value: "1"
    send-after:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "Repository ist gesund."
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸ’š Check OK: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "green_heart"        
    send-after-fail:
      - method: POST
        url: https://ntfy.home.wbrck.de/backup
        body: "${ERROR}\n\n${ERROR_STDERR}"
        headers:
          - name: Authorization
            value: Bearer {{ sops.ntfy.backup_token }}
          - name: Title
            value: "{% raw %}ðŸ’€ Check CRITICAL: {{ .Profile.Name }}{% endraw %}"
          - name: Tags
            value: "skull_and_crossbones"
          - name: Priority
            value: "4"

vaultwarden:
  inherit: default
  run-before:
    - "docker compose -f /opt/vaultwarden/docker-compose.yaml exec -T vaultwarden /vaultwarden backup"
    - >-
      /bin/sh -c 'latest=$(ls -t /srv/service_data/vw/db_[0-9]*.sqlite3 2>/dev/null | head -n 1);
      if [ -n "$latest" ]; then rm -f /srv/service_data/vw/db_backup.sqlite3; mv -- "$latest" /srv/service_data/vw/db_backup.sqlite3; fi'
    - >-
      /bin/sh -c 'rm -f /srv/service_data/vw/db_[0-9]*.sqlite3'
  backup:
    source:
      - "/srv/service_data/vw"
    schedule: "*-*-* 04:00:00" 
  check:
    schedule: "Sun *-*-* 04:30:00"
  exclude:
    - "/srv/service_data/vw/db.sqlite3"
    - "/srv/service_data/vw/db.sqlite3-wal"
    - "/srv/service_data/vw/db.sqlite3-shm"
    - "/srv/service_data/vw/tmp"
    - "/srv/service_data/vw/sends"

audiobookshelf:
  inherit: default
  run-before:
    - >-
      /bin/sh -c 'latest=$(ls -t /srv/service_data/audiobookshelf/metadata/backups/* 2>/dev/null | head -n 1);
      if [ -n "$latest" ]; then rm -f /srv/service_data/audiobookshelf/metadata/backups/audiobookshelf_backup.audiobookshelf; cp -a "$latest" /srv/service_data/audiobookshelf/metadata/backups/audiobookshelf_backup.audiobookshelf; fi'
  backup:
    source:
      - "/srv/service_data/audiobookshelf/audiobooks"
      - "/srv/service_data/audiobookshelf/podcasts"
      - "/srv/service_data/audiobookshelf/metadata/backups"
      - "/srv/service_data/audiobookshelf/config"
    schedule: "*-*-* 05:30:00"
  check:
    schedule: "*-*-01 02:00" 
